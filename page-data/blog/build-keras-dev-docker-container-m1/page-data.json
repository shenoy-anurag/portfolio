{
    "componentChunkName": "component---src-pages-markdown-remark-frontmatter-slug-js",
    "path": "/blog/build-keras-dev-docker-container-m1/",
    "result": {"data":{"markdownRemark":{"html":"<h2 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"custom-class before\"><svg width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill-rule=\"evenodd\" clip-rule=\"evenodd\"><path d=\"M14.851 11.923c-.179-.641-.521-1.246-1.025-1.749-1.562-1.562-4.095-1.563-5.657 0l-4.998 4.998c-1.562 1.563-1.563 4.095 0 5.657 1.562 1.563 4.096 1.561 5.656 0l3.842-3.841.333.009c.404 0 .802-.04 1.189-.117l-4.657 4.656c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-1.952-1.951-1.952-5.12 0-7.071l4.998-4.998c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464.493.493.861 1.063 1.105 1.672l-.787.784zm-5.703.147c.178.643.521 1.25 1.026 1.756 1.562 1.563 4.096 1.561 5.656 0l4.999-4.998c1.563-1.562 1.563-4.095 0-5.657-1.562-1.562-4.095-1.563-5.657 0l-3.841 3.841-.333-.009c-.404 0-.802.04-1.189.117l4.656-4.656c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464 1.951 1.951 1.951 5.119 0 7.071l-4.999 4.998c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-.494-.495-.863-1.067-1.107-1.678l.788-.785z\"/></svg></a>Overview</h2>\n<p>I faced several problems yesterday (2nd February, 2022) trying to get my keras-dev container up and running in order to contribute to keras open-source project. I would like to prevent others from ending up wasting their time trying to solve this, so that they can dive right into the interesting stuff -- contributing to keras.</p>\n<h2 id=\"problems-i-faced\" style=\"position:relative;\"><a href=\"#problems-i-faced\" aria-label=\"problems i faced permalink\" class=\"custom-class before\"><svg width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill-rule=\"evenodd\" clip-rule=\"evenodd\"><path d=\"M14.851 11.923c-.179-.641-.521-1.246-1.025-1.749-1.562-1.562-4.095-1.563-5.657 0l-4.998 4.998c-1.562 1.563-1.563 4.095 0 5.657 1.562 1.563 4.096 1.561 5.656 0l3.842-3.841.333.009c.404 0 .802-.04 1.189-.117l-4.657 4.656c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-1.952-1.951-1.952-5.12 0-7.071l4.998-4.998c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464.493.493.861 1.063 1.105 1.672l-.787.784zm-5.703.147c.178.643.521 1.25 1.026 1.756 1.562 1.563 4.096 1.561 5.656 0l4.999-4.998c1.563-1.562 1.563-4.095 0-5.657-1.562-1.562-4.095-1.563-5.657 0l-3.841 3.841-.333-.009c-.404 0-.802.04-1.189.117l4.656-4.656c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464 1.951 1.951 1.951 5.119 0 7.071l-4.999 4.998c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-.494-.495-.863-1.067-1.107-1.678l.788-.785z\"/></svg></a>Problems I faced</h2>\n<p>The biggest issue is that <code class=\"language-text\">Bazel</code> couldn't be installed within an <code class=\"language-text\">aarch64</code> docker container.</p>\n<p>Another issue was that <code class=\"language-text\">tf-nightly</code> couldn't be installed.</p>\n<h2 id=\"keras-dockerfile\" style=\"position:relative;\"><a href=\"#keras-dockerfile\" aria-label=\"keras dockerfile permalink\" class=\"custom-class before\"><svg width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill-rule=\"evenodd\" clip-rule=\"evenodd\"><path d=\"M14.851 11.923c-.179-.641-.521-1.246-1.025-1.749-1.562-1.562-4.095-1.563-5.657 0l-4.998 4.998c-1.562 1.563-1.563 4.095 0 5.657 1.562 1.563 4.096 1.561 5.656 0l3.842-3.841.333.009c.404 0 .802-.04 1.189-.117l-4.657 4.656c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-1.952-1.951-1.952-5.12 0-7.071l4.998-4.998c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464.493.493.861 1.063 1.105 1.672l-.787.784zm-5.703.147c.178.643.521 1.25 1.026 1.756 1.562 1.563 4.096 1.561 5.656 0l4.999-4.998c1.563-1.562 1.563-4.095 0-5.657-1.562-1.562-4.095-1.563-5.657 0l-3.841 3.841-.333-.009c-.404 0-.802.04-1.189.117l4.656-4.656c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464 1.951 1.951 1.951 5.119 0 7.071l-4.999 4.998c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-.494-.495-.863-1.067-1.107-1.678l.788-.785z\"/></svg></a>Keras Dockerfile</h2>\n<p>The Dockerfile keras provides you has a Bazel section which looks something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Install Bazel</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt update</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt install curl gnupg -y</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor > bazel.gpg</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mv bazel.gpg /etc/apt/trusted.gpg.d/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> echo <span class=\"token string\">\"deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8\"</span> | tee /etc/apt/sources.list.d/bazel.list</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt update &amp;&amp; apt install bazel -y</span></code></pre></div>\n<p>While this works with <code class=\"language-text\">amd64</code> (x86_64) systems, it doesn't work with <code class=\"language-text\">arm64</code> systems as the bazel package repository at <a href=\"https://storage.googleapis.com/bazel-apt\">https://storage.googleapis.com/bazel-apt</a> doesn't have any pre-built binaries for <code class=\"language-text\">arm64/aarch64</code> systems like the M1 macbooks.</p>\n<p>Due to this, we get an error like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> <span class=\"token operator\">=</span><span class=\"token operator\">></span> ERROR <span class=\"token punctuation\">[</span><span class=\"token number\">9</span>/9<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">apt</span> <span class=\"token function\">install</span> bazel -y                                        <span class=\"token number\">0</span>.5s\n------\n <span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token number\">9</span>/9<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">apt</span> <span class=\"token function\">install</span> bazel -y:\n <span class=\"token comment\">#12 0.123</span>\n <span class=\"token comment\">#12 0.123 WARNING: apt does not have a stable CLI interface. Use with </span>\n <span class=\"token comment\"># caution in scripts.</span>\n <span class=\"token comment\">#12 0.123</span>\n <span class=\"token comment\">#12 0.128 Reading package lists...</span>\n <span class=\"token comment\">#12 0.381 Building dependency tree...</span>\n <span class=\"token comment\">#12 0.448 Reading state information...</span>\n <span class=\"token comment\">#12 0.493 E: Unable to locate package bazel</span>\n------\nexecutor failed running <span class=\"token punctuation\">[</span>/bin/sh -c <span class=\"token function\">apt</span> <span class=\"token function\">install</span> bazel -y<span class=\"token punctuation\">]</span>: <span class=\"token builtin class-name\">exit</span> code: <span class=\"token number\">100</span></code></pre></div>\n<p>While looking for the solution, I stumbled upon this issue <a href=\"https://github.com/bazelbuild/bazel/issues/13925\">https://github.com/bazelbuild/bazel/issues/13925</a> which gave me hints as to what I should do.</p>\n<p>Github user <a href=\"https://github.com/keith\">@keith</a> mentioned an important point in the thread -- that bazel version 4.2.x is probably the first version to support M1 macs.</p>\n<p>And Github user <a href=\"https://github.com/philwo\">@philwo</a> recommended to download the arm64 linux binaries and modify their permissions to allow execution.</p>\n<p>Using these tips, I set about trying to make it work.\nHowever, I was still stuck and unable to get the bazel command to work.</p>\n<p>So I have decided to share the final solution and explain each step in case a beginner wants to contribute to keras on an <code class=\"language-text\">arm64/aarch</code> system like M1 Macbooks.</p>\n<p>The Dockerfile which solves all issues:</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:3.9</span>\n\n<span class=\"token comment\"># https://code.visualstudio.com/docs/remote/containers-advanced#_creating-a-nonroot-user</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> USERNAME=keras-vscode</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> USER_UID=1000</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> USER_GID=<span class=\"token variable\">$USER_UID</span></span>\n\n<span class=\"token comment\"># Create the user</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> groupadd --gid <span class=\"token variable\">$USER_GID</span> <span class=\"token variable\">$USERNAME</span> <span class=\"token operator\">\\</span>\n    &amp;&amp; useradd --uid <span class=\"token variable\">$USER_UID</span> --gid <span class=\"token variable\">$USER_GID</span> -m <span class=\"token variable\">$USERNAME</span> <span class=\"token operator\">\\</span>\n    <span class=\"token comment\">#</span>\n    <span class=\"token comment\"># [Optional] Add sudo support. Omit if you don't need to install software after connecting.</span>\n    &amp;&amp; apt-get update <span class=\"token operator\">\\</span>\n    &amp;&amp; apt-get install -y sudo bash <span class=\"token operator\">\\</span>\n    &amp;&amp; echo <span class=\"token variable\">$USERNAME</span> ALL=\\(root\\) NOPASSWD:ALL > /etc/sudoers.d/<span class=\"token variable\">$USERNAME</span> <span class=\"token operator\">\\</span>\n    &amp;&amp; chmod 0440 /etc/sudoers.d/<span class=\"token variable\">$USERNAME</span></span>\n\n<span class=\"token comment\"># Nano (to make my life easier)</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sudo apt install nano -y</span>\n\n<span class=\"token comment\"># Install Bazel arm64</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sudo apt update</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> wget https://github.com/bazelbuild/bazel/releases/download/4.2.1/bazel-4.2.1-linux-arm64</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sudo mkdir /usr/local/bin/bazel</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sudo mv  bazel-4.2.1-linux-arm64 /usr/local/bin/bazel</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sudo chmod +x /usr/local/bin/bazel/bazel-4.2.1-linux-arm64</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> export PATH=<span class=\"token string\">\"$PATH:/usr/local/bin/bazel\"</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> echo <span class=\"token string\">'export PATH=\"$PATH:/usr/local/bin/bazel\"'</span> >> ~/.bashrc</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sudo ln -s /usr/local/bin/bazel/bazel-4.2.1-linux-arm64 /usr/bin/bazel</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sudo bazel</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> <span class=\"token variable\">$USERNAME</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PATH=<span class=\"token string\">\"/home/$USERNAME/.local/bin:${PATH}\"</span></span></code></pre></div>\n<p>The <code class=\"language-text\">wget</code> line downloads the 4.2.1 version of Bazel built for arm64 systems to the present working directory (PWD).</p>\n<p>We create the destination folder in the following line and move the downloaded Bazel binary to it.</p>\n<p>We then allow the file to be executed by using the <code class=\"language-text\">chmod +x</code> command.</p>\n<p>After that, we add the path to our PATH environment variable so that the OS can recognize when we type a command (<code class=\"language-text\">bazel</code>).</p>\n<p><code class=\"language-text\">RUN sudo ln -s /usr/local/bin/bazel/bazel-4.2.1-linux-arm64 /usr/bin/bazel</code></p>\n<p>In this line, we create a symlink to the binary file from <code class=\"language-text\">/usr/bin/bazel</code>. This tells the OS that whenever we type <code class=\"language-text\">bazel</code> in the command line, we want it to execute the file <code class=\"language-text\">bazel-4.2.1-linux-arm64</code>.</p>\n<p>Finally, <code class=\"language-text\">sudo bazel</code> extracts the binary.</p>\n<p>Now, the docker container will be built successfully and you will have bazel ready to use.</p>\n<p>I have added the above as a Gist here: <a href=\"https://gist.github.com/shenoy-anurag/e501fbef1ba551b04404a3e173533aa8\">https://gist.github.com/shenoy-anurag/e501fbef1ba551b04404a3e173533aa8</a></p>\n<h2 id=\"python-requirements\" style=\"position:relative;\"><a href=\"#python-requirements\" aria-label=\"python requirements permalink\" class=\"custom-class before\"><svg width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill-rule=\"evenodd\" clip-rule=\"evenodd\"><path d=\"M14.851 11.923c-.179-.641-.521-1.246-1.025-1.749-1.562-1.562-4.095-1.563-5.657 0l-4.998 4.998c-1.562 1.563-1.563 4.095 0 5.657 1.562 1.563 4.096 1.561 5.656 0l3.842-3.841.333.009c.404 0 .802-.04 1.189-.117l-4.657 4.656c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-1.952-1.951-1.952-5.12 0-7.071l4.998-4.998c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464.493.493.861 1.063 1.105 1.672l-.787.784zm-5.703.147c.178.643.521 1.25 1.026 1.756 1.562 1.563 4.096 1.561 5.656 0l4.999-4.998c1.563-1.562 1.563-4.095 0-5.657-1.562-1.562-4.095-1.563-5.657 0l-3.841 3.841-.333-.009c-.404 0-.802.04-1.189.117l4.656-4.656c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464 1.951 1.951 1.951 5.119 0 7.071l-4.999 4.998c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-.494-.495-.863-1.067-1.107-1.678l.788-.785z\"/></svg></a>Python Requirements</h2>\n<p>The next step according to the <a href=\"https://github.com/keras-team/keras/blob/7857fa00431634ce59585e087d2d694b81669548/CONTRIBUTING.md\">Keras contributing guidelines</a> is to install the python requirements.</p>\n<p>You will get another error for tf-nightly. This is because tf-nightly doesn't have any <code class=\"language-text\">aarch64</code> wheels.</p>\n<p>Instead, install <code class=\"language-text\">tensorflow-aarch64</code> which has wheels built for aarch64, but the latest version as of today is 2.7.0. However, you'll have to make do, unless you build tensorflow from scratch from the latest git repo code.</p>\n<p>Mike Chan has a good article on that on medium: <a href=\"https://medium.com/@m7807031/how-to-install-tensorflow-in-different-os-languane-framework-66b3beaa1b3d\">https://medium.com/@m7807031/how-to-install-tensorflow-in-different-os-languane-framework-66b3beaa1b3d</a></p>\n<p>We'll go with <a href=\"https://github.com/KumaTea/tensorflow-aarch64\"><code class=\"language-text\">tensorflow-aarch64</code></a></p>\n<p>Install using:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pip install tensorflow-aarch64</code></pre></div>\n<p>or better yet, replace the line <code class=\"language-text\">tf-nightly</code> in <code class=\"language-text\">requirements.txt</code> with <code class=\"language-text\">tensorflow-aarch64</code>.</p>\n<p>and continue with the steps on Keras's contributing guidelines page.</p>\n<h2 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"custom-class before\"><svg width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill-rule=\"evenodd\" clip-rule=\"evenodd\"><path d=\"M14.851 11.923c-.179-.641-.521-1.246-1.025-1.749-1.562-1.562-4.095-1.563-5.657 0l-4.998 4.998c-1.562 1.563-1.563 4.095 0 5.657 1.562 1.563 4.096 1.561 5.656 0l3.842-3.841.333.009c.404 0 .802-.04 1.189-.117l-4.657 4.656c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-1.952-1.951-1.952-5.12 0-7.071l4.998-4.998c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464.493.493.861 1.063 1.105 1.672l-.787.784zm-5.703.147c.178.643.521 1.25 1.026 1.756 1.562 1.563 4.096 1.561 5.656 0l4.999-4.998c1.563-1.562 1.563-4.095 0-5.657-1.562-1.562-4.095-1.563-5.657 0l-3.841 3.841-.333-.009c-.404 0-.802.04-1.189.117l4.656-4.656c.975-.976 2.256-1.464 3.536-1.464 1.279 0 2.56.488 3.535 1.464 1.951 1.951 1.951 5.119 0 7.071l-4.999 4.998c-.975.976-2.255 1.464-3.535 1.464-1.28 0-2.56-.488-3.535-1.464-.494-.495-.863-1.067-1.107-1.678l.788-.785z\"/></svg></a>References</h2>\n<ol>\n<li>Bazel issue on Github <a href=\"https://github.com/bazelbuild/bazel/issues/13925\">https://github.com/bazelbuild/bazel/issues/13925</a></li>\n<li><a href=\"https://medium.com/@m7807031/how-to-install-tensorflow-in-different-os-languane-framework-66b3beaa1b3d\">https://medium.com/@m7807031/how-to-install-tensorflow-in-different-os-languane-framework-66b3beaa1b3d</a></li>\n<li>Symbolic Links <a href=\"https://www.freecodecamp.org/news/symlink-tutorial-in-linux-how-to-create-and-remove-a-symbolic-link/\">https://www.freecodecamp.org/news/symlink-tutorial-in-linux-how-to-create-and-remove-a-symbolic-link/</a></li>\n<li>Install Bazel Ubuntu (x86/amd64) <a href=\"https://docs.bazel.build/versions/main/install-ubuntu.html\">https://docs.bazel.build/versions/main/install-ubuntu.html</a></li>\n</ol>","frontmatter":{"date":"February 03, 2022","slug":"/blog/build-keras-dev-docker-container-m1","title":"Building Keras-Dev Docker Container on arm64/aarch64 systems like M1 Macbooks"}}},"pageContext":{"id":"42a4fccd-36e5-5112-8f98-6576216552f1","frontmatter__slug":"/blog/build-keras-dev-docker-container-m1","__params":{"frontmatter__slug":"blog"}}},
    "staticQueryHashes": ["63159454"]}